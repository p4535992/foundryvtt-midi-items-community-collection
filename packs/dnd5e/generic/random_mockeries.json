{
  "name": "Random Mockeries",
  "permission": {
    "default": 0
  },
  "type": "script",
  "flags": {},
  "scope": "global",
  "command": "// Courtesy of @Zarek\r\n// Selected target receives a random mockery from a table called \"mockeries\" along with the DC and damage.\r\n// You can find a table called mockeries in the community tables module.\r\n\r\n\r\nlet tableName = \"mockeries\";\r\n// default mockery if no table found.\r\nlet mockery = \"Now go away or I shall taunt you a second time-a!\";\r\n\r\nlet viciousMockeries = async () => {\r\n  if (!actor) {\r\n    ui.notifications.warn(\"You must have an actor selected.\");\r\n    return\r\n  }\r\n\r\n  let actorLevels = actor.data.data.levels || 1;\r\n  let table = game.tables.contents.find(t => t.name == tableName);\r\n\r\n  // Get Targets name\r\n  const targetId = game.user.targets.ids[0];\r\n  const targetToken = canvas.tokens.get(targetId);\r\n  if (!targetToken) {\r\n    ui.notifications.warn(\"You must target a token.\");\r\n    return\r\n  }\r\n  const targetName = targetToken.name;\r\n\r\n  // Roll the result, and mark it drawn\r\n  if (table) {\r\n    if (checkTable(table)) {\r\n      let roll = await table.roll();\r\n      let result = roll.results[0];\r\n      mockery = result.data.text;\r\n      await table.updateEmbeddedDocuments(\"TableResult\", [{\r\n        _id: result.id,\r\n        drawn: true\r\n      }]);\r\n    }\r\n  }\r\n\r\n  function checkTable(table) {\r\n    let results = 0;\r\n    for (let data of table.data.results) {\r\n      if (!data.drawn) {\r\n        results++;\r\n      }\r\n    }\r\n    if (results < 1) {\r\n      table.reset();\r\n      ui.notifications.notify(\"Table Reset\")\r\n      return false\r\n    }\r\n    return true\r\n  }\r\n\r\n  // Add a message with damage roll\r\n  let numDie = 1;\r\n  if (actorLevels >= 17) {\r\n    numDie = 4;\r\n  } else if (actorLevels >= 11) {\r\n    numDie = 3;\r\n  } else if (actorLevels >= 5) {\r\n    numDie = 2;\r\n  }\r\n\r\n  let messageContent = `<p>${targetName} Roll WIS save DC [[8+${actor.data.data.abilities.cha.mod}+@attributes.prof]] or take [[${numDie}d4]] damage and have disadvantage.</p>`\r\n  messageContent += `<p>${token.name} exclaims <b><i>\"${mockery}\"</i></b></p>`\r\n  messageContent += `<details closed=\"\"><summary><a>Vicious Mockery</a></summary><p>You unleash a string of insults laced with subtle enchantments at a creature you can see within range. If the target can hear you (though it need not understand you), it must succeed on a <strong>Wisdom saving throw</strong> or take <strong>1d4 psychic damage</strong> and have <strong>disadvantage on the next attack roll</strong> it makes before the end of its next turn.</p>\r\n    <p>This spellâ€™s damage increases by 1d4 when you reach 5th level ([[/r 2d4]]), 11th level ([[/r 3d4]]), and 17th level ([[/r 4d4]]).</p></details>`\r\n\r\n  // create the message\r\n  if (messageContent !== '') {\r\n    let chatData = {\r\n      user: game.user.id,\r\n      speaker: ChatMessage.getSpeaker(),\r\n      content: messageContent,\r\n    };\r\n    ChatMessage.create(chatData, {});\r\n  }\r\n};\r\n\r\nviciousMockeries();\r\n",
  "author": "",
  "img": "icons/svg/dice-target.svg",
  "actorIds": [],
  "_id": "bUEeDjvYU5xEtZAr"
}
