{
  "name": "NPCs to Coin Piles",
  "permission": {
    "default": 0
  },
  "type": "script",
  "flags": {},
  "scope": "global",
  "command": "///////////////////////////////////////////////////////\r\n//////////////////// CREATED BY ///////////////////////\r\n///////////////////////////////////////////////////////\r\n// This macro was created by u/shuggaloaf.\r\n// https://github.com/Shuggaloaf/NPC-to-Coin-Pile\r\n// FOR A FULL DESCRIPTION -INCLUDING EXAMPLE GIFS-\r\n// GO TO THE LINK ABOVE\r\n//\r\n// Images linked below created using game-icons.net \r\n// and may not be used for any commerical purposes. \r\n//\r\n// Enjoy! \r\n///////////////////////////////////////////////////////\r\n\r\n\r\n///////////////////////////////////////////////////////\r\n//////////////////// MACRO SYNOPSIS ///////////////////\r\n///////////////////////////////////////////////////////\r\n//   \r\n//  Checks to make sure each selected token is an NPC\r\n//  and if so rolls separately for each token to:\r\n//     - determine random coinage (if any), \r\n//     - adds that coin to the token,\r\n//     - turns token into an Item Pile\r\n//     - Adds a special effect to the token\r\n//          (if you desire)\r\n///////////////////////////////////////////////////////\r\n\r\n\r\n/////////////////////////////////////////////////////\r\n//////////////////// USER OPTIONS ///////////////////\r\n/////////////////////////////////////////////////////\r\n//\r\n//   You can have a Light Effect, an Image Change\r\n//   or Both or Neither.    \r\n//   You may also use this with our without the module \r\n//   Item Piles. \r\n//\r\n// ITEM PILES INTEGRATION\r\n//   If you have the Item Piles module, this macro \r\n//   can automatically make all selected tokens \r\n//   player-lootable.  \r\n//   \r\n//  To TURN OFF integration change the option on the \r\n//  line below to 0\r\n\r\n   let hasItemPiles = 1;  \r\n\r\n// change the 1 above to a 0 if you do not have Item \r\n// Piles, or do not want to use integration. \r\n\r\n                                                          \r\n// IMAGE CHANGE                                           \r\n//   Changes the token image. For example you could \r\n//   use a chest or a loot sack. \r\n//\r\n//   I cannot provide the image I personally use as\r\n//   it is commercial... \r\n//   However I made you a few free ones! Nothing fancy,\r\n//   but they're available here if you want: \r\n//    https://github.com/Shuggaloaf/NPC-to-Item-Pile/tree/main/img\r\n//\r\n//   If you use your own image and the lighting effect\r\n//   option keep in mind that image coloring can affect\r\n//   the intensity of the light effect\r\n//\r\n//   Whichever image you choose to use, since I do not\r\n//   know that path where you will store it,  \r\n//\r\n//   MAKE SURE to SET THE PATH on the next line:\r\n\r\n   let imgPath = \"Images/Icons/Custom/LootBag1.svg\";  \r\n//      Make this match your image path \r\n\r\n// LIGHT EFFECT\r\n//   Creates a color-shifting light effect. \r\n//   WARNING: This will overwrite any existing lighting. \r\n//     However, since they'd likely be dead at this point,\r\n//     this probably doesn't matter too much. \r\n//\r\n//\r\n// OPTION SELECTION\r\n//   To change options, set the number after the\r\n//   \"userOption =\" below to your choice. \r\n//\r\n//   Coin roll and -if enabled- \r\n//   Item Pile Transformation PLUS:\r\n//       0 = No Special Effect       \r\n//       1 = Light Effect only\r\n//       2 = Change Image Only\r\n//       3 = Both Image Change and Light effect\r\n\r\n   let userOption = 1; \r\n// Change the 1 to another option's number if you choose. \r\n   \r\n/////////////////////////////////////////////////////\r\n/////////////////////////////////////////////////////\r\n\r\n\r\n\r\n\r\nfor(let c of canvas.tokens.controlled){\r\n  if (c.actor.data.data.details.level > 0) {\r\n    console.log(\"XXXXX__//  \",c.data.name,\"is a PC   \\\\\\\\__XXXXX\");\r\n    continue;\r\n  } else {\r\n    let tokActor = c.actor;\r\n    \r\n    const rand = new Roll(\"1d100\").evaluate({async: false});\r\n\r\n    console.log(\"_________________________________________________________\")\r\n    console.log(\"!!!\",tokActor.data.name,\" Random Roll: \",rand.total);\r\n\r\n    ///////// Coins /////////\r\n    async function rollCoins(PP, GP, SP, CP) {    \r\n        let currency = tokActor.data.data.currency;\r\n    \r\n        let rollCP = await new Roll(CP).roll({async:true});\r\n        let rollSP = await new Roll(SP).roll({async:true});\r\n        let rollGP = await new Roll(GP).roll({async:true});\r\n        let rollPP = await new Roll(PP).roll({async:true});\r\n    \r\n        let actorCP = currency.cp + rollCP.total;\r\n        let actorSP = currency.sp + rollSP.total;\r\n        let actorGP = currency.gp + rollGP.total;\r\n        let actorPP = currency.pp + rollPP.total;\r\n        \r\n        await tokActor.update({\"data.currency.cp\": currency.cp + rollCP.total, \"data.currency.sp\": currency.sp + rollSP.total, \"data.currency.gp\": currency.gp + rollGP.total, \"data.currency.pp\": currency.pp + rollPP.total});\r\n\r\n        await console.log('>>>',tokActor.data.name,'Coins Added>>   CP:',rollCP.total,' // SP:',rollSP.total,' // GP:',rollGP.total,' // PP:',rollPP.total,' // ',);\r\n    }\r\n\r\n    if(rand.total<26){\r\n        console.log(\">>> No coins found\")                 //Nothing\r\n\r\n    } else if (rand.total>26 && rand.total<56){\r\n        await rollCoins(\"0\",\"0\",\"0\",\"1d10\");              //6CP avg\r\n    } else if (rand.total>55 && rand.total<80){\r\n        await rollCoins(\"0\",\"0\",\"4d3\",\"1d14+11\");         //1GP avg\r\n    } else if (rand.total>79 && rand.total<90){\r\n        await rollCoins(\"0\",\"2d3\",\"2d10+10\",\"1d21+39\");   //5GP avg\r\n    } else if (rand.total>89 && rand.total<95){\r\n        await rollCoins(\"0\",\"1d6+4\",\"7d5\",\"1d21+59\");     //10GP avg\r\n    } else if (rand.total>94 && rand.total<98){\r\n        await rollCoins(\"0\",\"1d10+5\",\"15d6\",\"50d3\");      //20GP avg\r\n    } else if (rand.total>97 && rand.total<100){\r\n        await rollCoins(\"1d3\",\"10d3+3\",\"15d6\",\"40d4\");    //50GP avg\r\n    } else {\r\n        await rollCoins(\"3d3\",\"24d2\",\"10d6\",\"25d6\");      //100GP avg\r\n    }\r\n    \r\n    console.log(\"_________________________________________________________\")   \r\n    \r\n     \r\n    if (c.actor.data.data.details.level > 0) {\r\n       break;\r\n    } else {   \r\n        if (hasItemPiles === 1){\r\n            ItemPiles.API.turnTokensIntoItemPiles(c);\r\n        }\r\n        if (userOption === 0){\r\n        }else if (userOption === 1){\r\n            await c.data.document.update({\r\n                light:{\r\n                    dim:0.2,\r\n                    bright:0.2,\r\n                    luminosity:0,\r\n                    alpha:1,\r\n                    color:'#ad8800',\r\n                    coloration:6,\r\n                    animation:{\r\n                        type:\"radialrainbow\",\r\n                        speed:3,\r\n                        intensity:10\r\n                    }\r\n                }\r\n            });\r\n        } else if (userOption === 2){\r\n            await c.document.update({img : imgPath, rotation : 0});\r\n        } else if (userOption === 3){\r\n            await c.data.document.update({\r\n                img: imgPath,\r\n                rotation : 0,\r\n                light:{\r\n                    dim:0.2,\r\n                    bright:0.2,\r\n                    luminosity:0,\r\n                    alpha:1,\r\n                    color:'#ad8800',\r\n                    coloration:6,\r\n                    animation:{\r\n                        type:\"radialrainbow\",\r\n                        speed:3,\r\n                        intensity:10\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            ui.notifications.error(`Error with User Options. Choose a valid option.`);\r\n        }\r\n    }\r\n  }\r\n}\r\n",
  "author": "",
  "img": "icons/svg/dice-target.svg",
  "actorIds": [],
  "_id": "rzxbsOTra01v56oH"
}
